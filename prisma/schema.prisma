generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum AuditAction {
  LOGIN
  LOGOUT
  UPDATE
  REGISTER
  UPDATE_PROFILE
  UPDATE_PASSWORD
  DELETE_ACCOUNT
  REFRESH_TOKEN
  REVOKE_TOKEN
}

enum AttachmentType {
  PAYMENT
  KTM
  ARTICLE
  LOA
}

model User {
  id       String   @id @default(uuid())
  email    String   @unique
  password String
  role     UserRole @default(USER)
  status   UserStatus @default(ACTIVE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile          Profile?
  trainingFlow     UserTrainingFlow?
  sessions         Session[]
  auditLogs        AuditLog[]
  attachments      Attachment[]
  feedbacks        Feedback[]

  @@map("users")
}

model Profile {
  id             String   @id @default(uuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fullName       String
  nim            String   @unique
  phone          String
  faculty        String?
  major          String?
  studyProgram   String?
  enrollmentYear Int?
  birthPlace     String
  birthDate      DateTime
  gender         String
  ktmPath        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("profiles")
}

model UserTrainingFlow {
  userId       String   @id
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  statusCode   String
  status       LookupStatus @relation(fields: [statusCode], references: [code])
  trainingId   String?
  training     Training? @relation(fields: [trainingId], references: [id])
  ojsAccountId String?  @unique
  ojsAccount   OjsAccount? @relation(fields: [ojsAccountId], references: [id])
  articleTitle String?
  journalCode  String?
  isLocked     Boolean? @default(false)
  lockedReason String?
  version      Int      @default(1)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([statusCode])
  @@index([trainingId])
  @@map("user_training_flows")
}

model LookupStatus {
  code        String   @id
  label       String
  step        Int
  description String?
  isActive    Boolean  @default(true)
  flows       UserTrainingFlow[]

  @@map("lookup_status")
}

model Training {
  id          String   @id @default(uuid())
  batch       String
  title       String
  startAt     DateTime
  endAt       DateTime
  location    String
  journalCode String
  mentorName  String
  quota       Int
  createdAt   DateTime @default(now())
  flows       UserTrainingFlow[]

  @@map("trainings")
}

model LookupJournal {
  code     String  @id
  name     String
  isActive Boolean @default(true)

  @@map("lookup_journals")
}

model OjsAccount {
  id          String @id @default(uuid())
  username    String
  password    String
  journalCode String
  journalLink String
  createdAt   DateTime @default(now())
  flow        UserTrainingFlow?

  @@map("ojs_accounts")
}

model Attachment {
  id           String  @id @default(uuid())
  userId       String
  user         User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  type         AttachmentType
  filePath     String
  mimeType     String
  originalName String?
  size         Int?
  createdAt    DateTime @default(now())

  @@index([userId, type])
  @@map("attachments")
}

model SystemConfig {
  key         String  @id
  value       String
  description String?
  updatedAt   DateTime @updatedAt

  @@map("system_configs")
}

model Feedback {
  id        String @id @default(uuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  message   String
  createdAt DateTime @default(now())

  @@map("feedbacks")
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshToken String   @unique
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@map("sessions")
}

model AuditLog {
  id        String      @id @default(uuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  action    AuditAction
  metadata  Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}